# 
# LogUI Server docker-compose File
# 
# Author: David Maxwell
# Date: 2020-11-17
#

version: "3.0"

services:
  proxy:
    build:
      context: ./proxy
    restart: always
    depends_on:
      - http-worker
      - websocket-worker
    ports:
      - ${PROXY_LISTEN_ON}:8000
    volumes:
      - static:/logui/static/
    networks:
      - frontend

  http-worker:
    build:
        context: ./
        dockerfile: ./worker/Dockerfile
        args:
          - SECRET_KEY=${SECRET_KEY}  # This is required for collectstatic to work.
    env_file: .env
    environment:
      - PYTHONDONTWRITEBYTECODE=1
      - PYTHONUNBUFFERED=1
    restart: always
    volumes:
      - static:/logui/static/
    networks:
      - frontend
      - backend
  
  websocket-worker:
    build:
      context: ./
      dockerfile: ./worker/Dockerfile
    command: daphne -b 0.0.0.0 -p 8000 worker.asgi:logui_application
    env_file: .env
    environment:
      - PYTHONDONTWRITEBYTECODE=1
      - PYTHONUNBUFFERED=1
    restart: always
    volumes:
      - static:/logui/static/
    networks:
      - frontend
      - backend

  # cache:
  #   networks:
  #     - backend

  # db:
  #   networks:
  #     - backend

  # logdb:
  #   networks:
  #     - backend

volumes:
  static:
  data:

networks:
  frontend:
  backend: